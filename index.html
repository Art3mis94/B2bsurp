<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>B2B Surplus â€“ Industrial Equipment Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --primary:#0052cc;
      --primary-light:#4c84ff;
      --bg:#f7f9fc;
      --card:#ffffff;
      --text:#202124;
      --muted:#5f6368;
      --border:#dadce0;
      --radius:12px;
      --shadow:0 4px 12px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Google Sans','Roboto',Arial,sans-serif;}
    body{background:var(--bg);color:var(--text);line-height:1.4;}
    a{text-decoration:none;color:inherit;}
    button{cursor:pointer;border:none;background:none;font-size:14px;font-weight:500;border-radius:6px;padding:8px 16px;transition:.2s;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-primary:hover{background:var(--primary-light);}
    .btn-outline{border:1px solid var(--border);}
    header{position:sticky;top:0;z-index:100;background:var(--card);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:12px 24px;}
    .logo{font-size:22px;font-weight:700;color:var(--primary);}
    .search-bar{flex:1;max-width:500px;margin:0 24px;display:flex;align-items:center;background:var(--bg);border-radius:24px;padding:0 16px;}
    .search-bar input{border:none;background:none;outline:none;width:100%;padding:10px;font-size:14px;}
    .filters{margin:24px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    .filters select,.filters input{padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;}
    main{max-width:1200px;margin:auto;padding:24px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:.2s;}
    .card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1);}
    .card img{width:100%;height:200px;object-fit:cover;background:#e8eaed;}
    .card-body{padding:16px;flex:1;display:flex;flex-direction:column;}
    .card-title{font-size:16px;font-weight:600;margin-bottom:4px;}
    .card-meta{font-size:13px;color:var(--muted);}
    .card-price{margin-top:auto;font-size:18px;font-weight:700;color:var(--primary);}
    .badge{position:absolute;top:12px;left:12px;background:var(--primary);color:#fff;font-size:12px;padding:4px 10px;border-radius:4px;}
    .relative{position:relative;}
    .center{display:flex;align-items:center;justify-content:center;height:60vh;flex-direction:text-align:center;color:var(--muted);}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;align-items:center;justify-content:center;}
    .modal.show{display:flex;}
    .modal-content{background:var(--card);border-radius:var(--radius);padding:32px;max-width:420px;width:90%;}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .close{cursor:pointer;font-size:24px;color:var(--muted);}
    .field{margin-bottom:16px;display:flex;flex-direction:column;}
    .field label{font-size:13px;margin-bottom:6px;color:var(--muted);}
    .field input,.field textarea,.field select{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:14px;}
    .field textarea{resize:vertical;min-height:80px;}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px;}
    .chat-window{position:fixed;bottom:24px;right:24px;width:320px;height:420px;background:var(--card);border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.15);display:none;flex-direction:column;z-index:150;}
    .chat-header{background:var(--primary);color:#fff;padding:12px 16px;border-radius:var(--radius) var(--radius) 0 0;display:flex;justify-content:space-between;align-items:center;}
    .chat-body{flex:1;padding:12px;overflow-y:auto;font-size:14px;}
    .chat-footer{display:flex;padding:12px;border-top:1px solid var(--border);}
    .chat-footer input{flex:1;border:none;outline:none;padding:8px;font-size:14px;}
    .chat-footer button{background:var(--primary);color:#fff;padding:8px 12px;border-radius:6px;margin-left:8px;}
    .msg{margin-bottom:8px;}
    .msg.you{text-align:right;}
    .msg.you span{background:var(--primary-light);color:#fff;display:inline-block;padding:6px 12px;border-radius:12px;}
    .msg.them span{background:var(--bg);display:inline-block;padding:6px 12px;border-radius:12px;}
    .sign-in-btn{background:#fff;color:var(--primary);border:1px solid var(--primary);padding:8px 16px;border-radius:6px;font-weight:500;}
    
    /* Hero Section */
    .hero {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 4rem 2rem;
      text-align: center;
      margin-top: 0;
    }
    .hero h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .hero p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }
    .cta-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background-color: #f39c12;
      color: white;
    }
    .btn-primary:hover {
      background-color: #e67e22;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: transparent;
      color: white;
      border: 2px solid white;
    }
    .btn-secondary:hover {
      background-color: white;
      color: #1e3a8a;
    }
    
    /* Admin Styles */
    .admin-only { display: none; }
    .admin-bar {
      background: #d32f2f;
      color: white;
      padding: 8px 24px;
      font-size: 14px;
      display: none;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .admin-table th,
    .admin-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .admin-table th {
      background: var(--bg);
      font-weight: 600;
    }
    .admin-table tr:hover {
      background: rgba(0,0,0,.02);
    }
    .edit-input {
      border: 1px solid var(--primary);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      width: 100%;
    }
    .admin-actions {
      display: flex;
      gap: 8px;
    }
    .admin-login {
      max-width: 400px;
      margin: 100px auto;
      padding: 32px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .admin-login h2 {
      margin-bottom: 24px;
      text-align: center;
    }
    .role-badge {
      background: #d32f2f;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    @media(max-width:600px){
      .filters{flex-direction:column;align-items:stretch;}
      .search-bar{margin:12px 0;}
      .hero h1 {font-size: 2rem;}
      .admin-table { font-size: 14px; }
      .admin-table th,
      .admin-table td { padding: 8px 12px; }
    }
  </style>
</head>
<body>

<!-- Admin Bar (shown only to admins) -->
<div id="adminBar" class="admin-bar">
  ðŸ”’ Admin Mode | <a href="#admin" style="color:white;text-decoration:underline;">Dashboard</a>
</div>

<!-- ===== HEADER ===== -->
<header>
  <div class="logo">B2B Surplus</div>
  <div class="search-bar">
    <span class="material-icons" style="color:var(--muted);font-size:20px;">search</span>
    <input id="globalSearch" placeholder="Search equipment, SKU, companyâ€¦">
  </div>
  <div>
    <button id="openChatBtn" class="btn-outline" style="margin-right:8px;">
      <span class="material-icons" style="vertical-align:middle;">chat</span>
    </button>
    <button id="signInBtn" class="sign-in-btn">Sign In</button>
    <button id="userMenu" class="btn-primary" style="display:none;">Account</button>
</div>
</header>

<!-- ===== HERO SECTION ===== -->
<section class="hero">
  <h1>Industrial Equipment Marketplace</h1>
  <p>Buy and sell used, refurbished, and surplus industrial equipment with confidence</p>
  <div class="cta-buttons">
    <button class="btn btn-primary" onclick="scrollToListings()">Browse Equipment</button>
    <button class="btn btn-secondary" onclick="document.getElementById('sellBtn').click()">List Your Equipment</button>
  </div>
</section>

<!-- ===== FILTERS ===== -->
<div class="filters">
  <select id="sectorFilter">
    <option value="">All Sectors</option>
    <option>Manufacturing</option>
    <option>Construction</option>
    <option>Energy</option>
    <option>Medical</option>
    <option>Food & Beverage</option>
  </select>

  <select id="conditionFilter">
    <option value="">Any Condition</option>
    <option>New</option>
    <option>Refurbished</option>
    <option>Used â€“ Good</option>
    <option>Used â€“ Fair</option>
  </select>

  <select id="sortBy">
    <option value="dateDesc">Newest</option>
    <option value="dateAsc">Oldest</option>
    <option value="priceAsc">Price â†‘</option>
    <option value="priceDesc">Price â†“</option>
  </select>

  <input type="number" id="priceMin" placeholder="Min price ($)" style="width:120px;">
  <input type="number" id="priceMax" placeholder="Max price ($)" style="width:120px;">

  <button id="resetFilters" class="btn-outline">Reset</button>
  <button id="sellBtn" class="btn-primary">+ List Equipment</button>
</div>

<!-- ===== MAIN GRID (Market View) ===== -->
<main id="marketView">
  <div id="equipmentGrid" class="grid"><!-- JS populated --></div>
</main>

<!-- ===== ADMIN LOGIN PAGE ===== -->
<div id="adminLoginView" style="display:none;">
  <div class="admin-login">
    <h2>Admin Login</h2>
    <form id="adminLoginForm">
      <div class="field">
        <label>Email</label>
        <input type="email" name="email" required>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" name="password" required>
      </div>
      <div class="actions">
        <button type="button" class="btn-outline" onclick="showMarket()">Cancel</button>
        <button type="submit" class="btn-primary">Login</button>
      </div>
    </form>
    <div style="margin-top:16px;text-align:center;">
      <button class="btn-outline" onclick="adminGoogleSignIn()">
        <span class="material-icons" style="vertical-align:middle;font-size:18px;">login</span>
        Google Admin Login
      </button>
    </div>
  </div>
</div>

<!-- ===== ADMIN DASHBOARD ===== -->
<div id="adminDashboardView" style="display:none;">
  <main>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <h1>Admin Dashboard</h1>
      <div>
        <button class="btn-outline" onclick="showMarket()">Back to Market</button>
        <button class="btn-primary" onclick="auth.signOut()">Logout</button>
      </div>
    </div>
    
    <div style="margin-bottom:24px;">
      <h2>All Listings</h2>
      <div style="margin-top:12px;font-size:14px;color:var(--muted);">
        Click any cell to edit inline. Changes auto-save.
      </div>
    </div>
    
    <table class="admin-table" id="adminTable">
      <thead>
        <tr>
          <th>Title</th>
          <th>Sector</th>
          <th>Condition</th>
          <th>Price</th>
          <th>Seller</th>
          <th>Listed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminTableBody">
        <!-- Populated by JS -->
      </tbody>
    </table>
  </main>
</div>

<!-- ===== LISTING MODAL ===== -->
<div id="listingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>List Equipment</h3>
      <span class="close" data-close>&times;</span>
    </div>
    <form id="listingForm">
      <div class="field"><label>Title</label><input name="title" required></div>
      <div class="field"><label>Description</label><textarea name="description" required></textarea></div>
      <div class="field"><label>Sector</label>
        <select name="sector" required>
          <option>Manufacturing</option><option>Construction</option><option>Energy</option><option>Medical</option><option>Food & Beverage</option>
        </select>
      </div>
      <div class="field"><label>Condition</label>
        <select name="condition" required>
          <option>New</option><option>Refurbished</option><option>Used â€“ Good</option><option>Used â€“ Fair</option>
        </select>
      </div>
      <div class="field"><label>Price ($)</label><input type="number" name="price" required></div>
      <div class="field"><label>External Image URL (optional)</label><input type="url" name="imageUrl" placeholder="https://example.com/image.jpg"></div>
      <div class="actions">
        <button type="button" data-close class="btn-outline">Cancel</button>
        <button type="submit" class="btn-primary">Publish</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== CHAT WINDOW ===== -->
<div id="chatWindow" class="chat-window">
  <div class="chat-header">
    <span>Messages</span>
    <span id="closeChat" class="close" style="color:#fff;">Ã—</span>
  </div>
  <div id="chatBody" class="chat-body"></div>
  <div class="chat-footer">
    <input id="chatInput" placeholder="Type messageâ€¦">
    <button id="sendMsg">Send</button>
  </div>
</div>

<script>
  /* ===== FIREBASE SETUP ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCrbAWZAiUuIfhwrPC0xa8WPTsVGJWDy1c",
    authDomain: "business2business-67222.firebaseapp.com",
    projectId: "business2business-67222",
    storageBucket: "business2business-67222.firebasestorage.app",
    messagingSenderId: "913722719592",
    appId: "1:913722719592:web:9d54f832b102e4d842aadd",
    measurementId: "G-BDWSNQPKSX"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ===== STATE ===== */
  let currentUser = null;
  let unsubListings = null;
  let activeChatId = null;
  let isAdmin = false;

  /* ===== AUTH ===== */
  auth.onAuthStateChanged(user => {
    currentUser = user;
    document.getElementById('signInBtn').style.display = user ? 'none' : 'inline-block';
    document.getElementById('userMenu').style.display = user ? 'inline-block' : 'none';
    
    if (user) {
      checkAdminClaim(user);
      loadListings();
      subscribeMessages();
    } else {
      isAdmin = false;
      document.getElementById('adminBar').style.display = 'none';
      showMarket();
    }
  });

  function checkAdminClaim(user) {
    user.getIdTokenResult().then(idTokenResult => {
      isAdmin = idTokenResult.claims.role === 'admin';
      document.getElementById('adminBar').style.display = isAdmin ? 'flex' : 'none';
      if (window.location.hash === '#admin' && !isAdmin) {
        window.location.hash = '';
        showMarket();
      }
    });
  }

  /* ===== ROUTING ===== */
  window.addEventListener('hashchange', handleRouting);
  handleRouting(); // initial call

  function handleRouting() {
    const hash = window.location.hash;
    if (hash === '#admin') {
      if (!currentUser) {
        window.location.hash = '#admin-login';
        return;
      }
      if (!isAdmin) {
        alert('Access denied. Admin privileges required.');
        window.location.hash = '';
        return;
      }
      showAdminDashboard();
    } else if (hash === '#admin-login') {
      showAdminLogin();
    } else {
      showMarket();
    }
  }

  function showMarket() {
    window.location.hash = '';
    document.getElementById('marketView').style.display = 'block';
    document.getElementById('adminLoginView').style.display = 'none';
    document.getElementById('adminDashboardView').style.display = 'none';
    loadListings();
  }

  function showAdminLogin() {
    document.getElementById('marketView').style.display = 'none';
    document.getElementById('adminLoginView').style.display = 'block';
    document.getElementById('adminDashboardView').style.display = 'none';
  }

  function showAdminDashboard() {
    document.getElementById('marketView').style.display = 'none';
    document.getElementById('adminLoginView').style.display = 'none';
    document.getElementById('adminDashboardView').style.display = 'block';
    loadAdminListings();
  }

  /* ===== ADMIN LOGIN ===== */
  document.getElementById('adminLoginForm').onsubmit = async e => {
    e.preventDefault();
    const email = e.target.email.value;
    const password = e.target.password.value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
      window.location.hash = '#admin';
    } catch (err) {
      alert('Login failed: ' + err.message);
    }
  };

  function adminGoogleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(() => {
      window.location.hash = '#admin';
    }).catch(err => {
      alert('Google login failed: ' + err.message);
    });
  }

  /* ===== ADMIN LISTINGS ===== */
  function loadAdminListings() {
    db.collection('listings').orderBy('createdAt', 'desc').onSnapshot(snap => {
      const tbody = document.getElementById('adminTableBody');
      tbody.innerHTML = '';
      snap.forEach(doc => renderAdminRow(doc));
    });
  }

  function renderAdminRow(doc) {
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="edit-input" data-id="${doc.id}" data-field="title" value="${d.title}"></td>
      <td><input class="edit-input" data-id="${doc.id}" data-field="sector" value="${d.sector}"></td>
      <td><input class="edit-input" data-id="${doc.id}" data-field="condition" value="${d.condition}"></td>
      <td><input class="edit-input" data-id="${doc.id}" data-field="price" type="number" value="${d.price}"></td>
      <td>${d.sellerName}</td>
      <td>${new Date(d.createdAt?.toDate()).toLocaleDateString()}</td>
      <td class="admin-actions">
        <button class="btn-primary" onclick="startChat('${d.sellerId}','${d.sellerName}','${doc.id}')">Contact</button>
        <button class="btn-outline" onclick="deleteListing('${doc.id}')" style="color:#d32f2f;">Delete</button>
      </td>
    `;
    document.getElementById('adminTableBody').appendChild(tr);
    
    // Add auto-save listeners
    tr.querySelectorAll('.edit-input').forEach(input => {
      input.addEventListener('change', e => {
        const id = e.target.dataset.id;
        const field = e.target.dataset.field;
        const value = field === 'price' ? Number(e.target.value) : e.target.value;
        db.collection('listings').doc(id).update({[field]: value})
          .then(() => console.log('Updated', field))
          .catch(err => alert('Update failed: ' + err.message));
      });
    });
  }

  function deleteListing(id) {
    if (!confirm('Delete this listing permanently?')) return;
    db.collection('listings').doc(id).delete()
      .then(() => console.log('Deleted'))
      .catch(err => alert('Delete failed: ' + err.message));
  }

  /* ===== MARKET LISTINGS ===== */
  function loadListings(){
    if(unsubListings) unsubListings();
    const q = buildQuery();
    unsubListings = q.onSnapshot(snap => {
      const grid = document.getElementById('equipmentGrid');
      grid.innerHTML = '';
      snap.forEach(doc => renderCard(doc));
      if(!snap.size) grid.innerHTML = '<div class="center">No listings match your filters.</div>';
    });
  }

  function buildQuery(){
    let ref = db.collection('listings');
    const s = id => document.getElementById(id).value;
    if(s('sectorFilter')) ref = ref.where('sector','==',s('sectorFilter'));
    if(s('conditionFilter')) ref = ref.where('condition','==',s('conditionFilter'));
    const min = s('priceMin');
    const max = s('priceMax');
    if(min) ref = ref.where('price','>=',Number(min));
    if(max) ref = ref.where('price','<=',Number(max));
    const search = s('globalSearch').trim();
    if(search) ref = ref.where('keywords','array-contains',search.toLowerCase());

    const sort = s('sortBy');
    let field = 'createdAt', dir = 'desc';
    if(sort==='priceAsc'){ field='price'; dir='asc'; }
    if(sort==='priceDesc'){ field='price'; dir='desc'; }
    if(sort==='dateAsc'){ field='createdAt'; dir='asc'; }
    return ref.orderBy(field, dir);
  }

  function renderCard(doc){
    const d = doc.data();
    const div = document.createElement('div');
    div.className = 'card relative';
    div.innerHTML = `
      <div class="badge">${d.condition}</div>
      <img src="${d.imageUrl || 'https://via.placeholder.com/400x200?text=No+Image'}" alt="">
      <div class="card-body">
        <div class="card-title">${d.title}</div>
        <div class="card-meta">${d.sector} â€¢ Listed ${new Date(d.createdAt?.toDate()).toLocaleDateString()}</div>
        <div class="card-price">$${d.price.toLocaleString()}</div>
        <button class="btn-primary" style="margin-top:12px;width:100%;" onclick="startChat('${d.sellerId}','${d.sellerName}','${doc.id}')">Contact Seller</button>
      </div>
    `;
    document.getElementById('equipmentGrid').appendChild(div);
  }

  /* Filters */
  ['sectorFilter','conditionFilter','sortBy','priceMin','priceMax','globalSearch'].forEach(id => {
    document.getElementById(id).onchange = loadListings;
  });
  document.getElementById('resetFilters').onclick = () => {
    ['sectorFilter','conditionFilter','sortBy','priceMin','priceMax','globalSearch'].forEach(id => document.getElementById(id).value='');
    loadListings();
  };

  /* ===== LISTING FORM ===== */
  document.getElementById('sellBtn').onclick = () => modal(true);
  document.getElementById('listingForm').onsubmit = async e => {
    e.preventDefault();
    if(!currentUser){ alert('Please sign in first'); return; }
    const f = e.target;
    const data = {
      title: f.title.value,
      description: f.description.value,
      sector: f.sector.value,
      condition: f.condition.value,
      price: Number(f.price.value),
      sellerId: currentUser.uid,
      sellerName: currentUser.displayName || currentUser.email,
      sellerEmail: currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      keywords: f.title.value.toLowerCase().split(' '),
      imageUrl: f.imageUrl.value || ''
    };
    await db.collection('listings').add(data);
    modal(false);
    f.reset();
    alert('Equipment listed successfully!');
  };

  /* ===== CHAT ===== */
  window.startChat = (sellerId, sellerName, listingId) => {
    if(!currentUser){ alert('Sign in to message sellers'); return; }
    const chatId = [currentUser.uid, sellerId].sort().join('_');
    activeChatId = chatId;
    db.collection('chats').doc(chatId).set({
      participants: [currentUser.uid, sellerId],
      listingId: listingId
    }, { merge: true });
    document.getElementById('chatWindow').style.display = 'flex';
    renderMessages(chatId);
  };
  document.getElementById('closeChat').onclick = () => {
    document.getElementById('chatWindow').style.display = 'none';
    activeChatId = null;
  };
  document.getElementById('sendMsg').onclick = () => sendMessage();
  document.getElementById('chatInput').onkeyup = e => { if(e.key==='Enter') sendMessage(); };

  function sendMessage(){
    const input = document.getElementById('chatInput');
    if(!input.value.trim() || !activeChatId) return;
    db.collection('chats').doc(activeChatId).collection('messages').add({
      from: currentUser.uid,
      fromName: currentUser.displayName || currentUser.email,
      text: input.value,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value='';
  }
  function subscribeMessages(){
    if(!currentUser) return;
    db.collection('chats').where('participants','array-contains',currentUser.uid)
      .onSnapshot(snap => {
        snap.docChanges().forEach(change => {
          if(change.type==='added' || change.type==='modified'){
            renderMessages(change.doc.id);
          }
        });
      });
  }
  function renderMessages(chatId){
    if(chatId!==activeChatId) return;
    const body = document.getElementById('chatBody');
    body.innerHTML='';
    db.collection('chats').doc(chatId).collection('messages')
      .orderBy('ts','asc')
      .onSnapshot(snap => {
        body.innerHTML='';
        snap.forEach(doc => {
          const m = doc.data();
          const div = document.createElement('div');
          div.className = 'msg ' + (m.from===currentUser.uid ? 'you' : 'them');
          div.innerHTML = `<span>${m.text}</span>`;
          body.appendChild(div);
        });
        body.scrollTop = body.scrollHeight;
      });
  }

  /* ===== UTILS ===== */
  function modal(show){
    document.getElementById('listingModal').classList.toggle('show', show);
  }
  document.querySelectorAll('[data-close]').forEach(el => el.onclick = () => modal(false));
  
  function scrollToListings() {
    document.querySelector('.filters').scrollIntoView({ behavior: 'smooth' });
  }
</script>

</body>
</html>